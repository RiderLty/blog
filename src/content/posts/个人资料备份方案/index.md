---
title: ä¸ªäººèµ„æ–™å¤‡ä»½æ–¹æ¡ˆ
published: 2024-11-05
description: 'æ•°æ®æ— ä»·ï¼'
image: "./cover.png"
tags: [NAS,å¤‡ä»½]
category: 'NAS'
draft: false 
lang: ''
---
é«˜ä¸­çš„æ—¶å€™ï¼Œæ›¾ç»æœ‰ä¸€å—1Tçš„ç§»åŠ¨ç¡¬ç›˜ã€‚

é‡Œé¢å­˜æ»¡äº†æˆ‘ä»å„ç§åœ°æ–¹æ‰¾æ¥çš„ç”µå½±ã€åŠ¨æ¼«ã€éŸ³ä¹ï¼Œè¿˜æœ‰å¾ˆå¤šè‡ªå·±æ‹çš„ç…§ç‰‡è§†é¢‘ã€‚

ä½†æ˜¯åæ¥æŒ‚æ‰äº†ã€‚ã€‚ã€‚

å‡ å¹´çš„æ•°å­—å›å¿†çƒŸæ¶ˆäº‘æ•£ï¼Œè®©æˆ‘ç—›è‹¦åœ°æ„è¯†åˆ°äº†æ•°æ®å¤‡ä»½çš„é‡è¦æ€§ã€‚

è™½ç„¶è‡ªé‚£æ—¶å¼€å§‹å°±å°†æ•°æ®åœ¨æœ¬åœ°å’Œç½‘ç›˜éƒ½å­˜ä¸€ä»½äº†ï¼Œä½†æ˜¯ç”¨çš„æ˜¯onedrive E5ã€‚

è™½ç„¶åæ¥å·æ²¡äº†ï¼Œä½†æ˜¯æœ¬åœ°æ•°æ®è¿˜åœ¨ï¼Œæ‰€ä»¥åªæ˜¯æŸå¤±äº†ä¸€äº›ç”µå½±ã€‚

å†åæ¥å°±æ˜¯å¤šäº‘ç›˜+æœ¬åœ°å¤‡ä»½ï¼Œä¸»è¦æ•°æ®åœ¨æœ¬åœ°ï¼Œæ‰‹åŠ¨ä¸Šä¼ åˆ°äº‘ç«¯ã€‚

## 2023å¹´9æœˆ4æ—¥çš„æ•…äº‹

åˆæ˜¯æƒ¨ç—›çš„ä¸€å¤©ã€‚

å½“æ—¶ç”¨äºå¤‡ä»½çš„ç¡¬ç›˜æ˜¯æ’åœ¨è½¯è·¯ç”±ä¸Šï¼Œè½¯è·¯ç”±å™¨å®šæœŸå…¨ç›˜å¤‡ä»½åˆ°ç¡¬ç›˜ã€‚

äºæ˜¯å½“è½¯è·¯ç”±ä¸€æŒ‚æ‰ï¼Œç¬¬ä¸€ååº”å°±æ˜¯æ’å¡è¿›æ¢å¤ç³»ç»ŸDDä¸€ä¸‹ã€‚

ä½†æ˜¯ç”±äºæé”™äº†ç›®æ ‡åˆ†åŒºï¼Œç›´æ¥ç»™æˆ‘çš„ç¡¬ç›˜ç»™è¦†ç›–äº†ã€‚

ç”¨DGå°è¯•æ¢å¤äº†ä¸€äº›æ•°æ®ï¼Œä½†æ˜¯è¿˜æœ‰æœ‰å¾ˆå¤šæ²¡æ¥å¾—åŠä¸Šä¼ çš„ç…§ç‰‡æ— æ³•æ‰¾å›äº†ã€‚

è‡ªé‚£æ—¶èµ·å°±å†³å®šè¦åšå…¨è‡ªåŠ¨çš„å¤‡ä»½æ–¹æ¡ˆï¼Œè‡³äºæ•´äº†NASé‚£åˆæ˜¯åé¢çš„äº‹äº†ã€‚

## å·¥å…·é“¾

### termux

æ‰‹æœºä¸Šçš„ç»ˆç«¯ï¼Œå¯å®‰è£…arm64æ¶æ„çš„linuxè½¯ä»¶ã€‚é€šè¿‡termux:Taskeræ’ä»¶å¯è¢«å…¶ä»–è½¯ä»¶è°ƒç”¨æ‰§è¡Œè„šæœ¬ã€‚

### Macrodroid

æ‰‹æœºä¸Šçš„è‡ªåŠ¨åŒ–è½¯ä»¶ï¼Œé€šè¿‡å®šæ—¶ã€æ¡ä»¶æˆ–è€…æ‰‹åŠ¨ç­‰æ–¹å¼è§¦å‘ä»»åŠ¡å¹¶è°ƒç”¨termuxæ‰§è¡Œè„šæœ¬ã€‚

### Rclone

ä¼Ÿå¤§ï¼Œæ— éœ€å¤šè¨€ã€‚äº‘å­˜å‚¨çš„ç‘å£«å†›åˆ€ã€‚

### Alist

ä¸ºä¸€äº›ä¸æ”¯æŒRcloneåˆæ²¡æœ‰webdavçš„ç½‘ç›˜æä¾›ç»Ÿä¸€æ¥å£ã€‚

### å…¶ä»–çš„å‘½ä»¤è¡Œå·¥å…·

netcatã€ddã€tarã€ssh ...

:::tip[å…³äºDD | gzip]
ä½¿ç”¨DDå…¨ç›˜å¤åˆ¶å¹¶gzipçš„æ—¶å€™ï¼Œéœ€è¦æ‰‹åŠ¨å†™æ»¡å‰©ä½™ç©ºé—´ä»¥è¾¾åˆ°æœ€ä½³å‹ç¼©æ•ˆæœã€‚
```shell
DD if=/dev/zero of=./zero.img bs=65536
```
:::

## ä¸»è¦æ€è·¯

å°†è·¯ç”±å™¨ï¼Œæ‰‹æœºç­‰è®¾å¤‡çº¿å¤‡ä»½åˆ°NASï¼Œå†ç”±NASå®šæ—¶å¤‡ä»½åˆ°ç½‘ç›˜ã€‚

éƒ¨åˆ†æ”¹åŠ¨ä¸é¢‘ç¹çš„å¦‚è·¯ç”±å™¨æ‰‹åŠ¨å¤‡ä»½ï¼Œå…¶ä»–çš„è‡ªåŠ¨å¤‡ä»½ã€‚

## è·¯ç”±å™¨å¤‡ä»½

```shell
#!/bin/bash
ssh root@192.168.3.133 "netcat -l -v -p 1234 -w 10 | pigz > /mnt/storage/Backups/Router/R5C.backup.$(date '+%Y-%m-%d').img.gz" &
sleep 3 && dd if=/dev/mmcblk2 bs=65536 count=60620800 status=progress | netcat -c 192.168.3.133 1234 &
wait
```
sshè¿ä¸ŠNASä¸Šçš„LXCå¹¶å¼€å¯netcatæ¥æ”¶æ•°æ®ï¼Œå°†æ¥æ”¶åˆ°çš„æ•°æ®é€šè¿‡ç®¡é“å‘é€åˆ°pigzå‹ç¼©ï¼Œå†ä¿å­˜åˆ°é•œåƒæ–‡ä»¶ã€‚

è·¯ç”±å™¨DDå¤åˆ¶å…¨ç›˜é€šè¿‡netcatå‘é€ç»™NASå‹ç¼©å­˜æ¡£ã€‚

ä¿®æ”¹ifã€countä»¥åŠä¿å­˜æ–‡ä»¶çš„ä½ç½®ï¼Œç›´æ¥åœ¨è·¯ç”±å™¨ä¸Šæ‰§è¡Œæ­¤å‘½ä»¤å³å¯ã€‚

:::caution[é‡è¦äº‹é¡¹]
**æ¢å¤å¤‡ä»½æ—¶å€™ï¼Œåƒä¸‡æ³¨æ„é€‰æ‹©æ­£ç¡®çš„ç›®æ ‡ç£ç›˜ï¼ï¼ï¼**
:::
å¤åˆ¶å¤‡ä»½æ–‡ä»¶åˆ°Uç›˜å¹¶æ¢å¤ï¼š

```shell
dd if=/mnt/usb4-2/R5C.backup.2024-11-05.img.gzÂ bs=65536 count=60620800 of=/dev/mmcblk2 status=progress
```
æˆ–è€…ç›´æ¥ä»è¿œç¨‹è¯»å–æ–‡ä»¶ (è¿™ç§æ—¶å€™ä¸€èˆ¬éƒ½æ˜¯ç”¨æ¢å¤ç³»ç»Ÿè¿›çš„ï¼Œå°±ä¸é…ç½®sshäº†)ï¼š
```shell
pigz -dc R5C.backup.2024-11-05.img.gz | netcat -c 192.168.3.1 1234
```
```shell
netcat -l -v -p 1234 -w 10 | dd of=/dev/mmcblk2 bs=65536 count=60620800 status=progress
```
åˆæˆ–è€…æ˜¯ç”¨rcloneï¼š
```shell
rclone cat nas:storage/Backups/Router/R5C.backup.2024-11-05.img.gz |Â ddÂ bs=65536 count=60620800 of=/dev/mmcblk2 status=progress
```
status=progressç”¨äºæ˜¾ç¤ºè¿›åº¦ï¼Œåœ¨è½¯ä»¶åŒ…é‡Œæœ```coreutils-dd```

:::warning[å‹æƒ…æç¤º]
è·¯ç”±å™¨ç¨³å®šå¤§äºå¤©ï¼Œå°‘æŠ˜è…¾è¿™ç©æ„ã€‚
:::
## æ‰‹æœºå¤‡ä»½

termuxæœ¬ä½“çš„è®¾ç½®ï¼Œé€šè¿‡tarå‹ç¼©åå¤‡ä»½åˆ°NASã€‚

ä¸€èˆ¬æ˜¯è¿›è¡Œäº†ä»€ä¹ˆå¤§æ”¹åŠ¨åæ‰‹åŠ¨å¤‡ä»½ã€‚

```shell
#!/bin/bash
# directory å­˜æ”¾å¤‡ä»½æ–‡ä»¶ï¼Œåªä¿ç•™æœ€æ–°çš„ä¸‰ä¸ª
directory="/sdcard/termuxBackups"
cd "$directory"
files=($(ls -t *))
if [[ ${#files[@]} -gt 3 ]]; then
  delete_files=("${files[@]:3}")
  for file in "${delete_files[@]}"; do
    rm "$file"
    echo "åˆ é™¤äº†æ—§çš„å¤‡ä»½æ–‡ä»¶ï¼š$file"
  done
fi
tar --use-compress-program=pigz -cf /sdcard/termuxBackups/$(date '+%Y-%m-%d').tar.gz -C /data/data/com.termux/files ./home ./usr

echo "ä¸Šä¼ åˆ°NAS"

rclone sync /sdcard/termuxBackups nas:storage/Backups/termux -P

```

æ¢å¤å¤‡ä»½

```shell
tar -zxf /path/to/your/termux-backup.tar.gz -C /data/data/com.termux/files --recursive-unlink --preserve-permissions
```

å‚è€ƒï¼š[Backing up Termux - Termux Wiki](https://wiki.termux.com/wiki/Backing_up_Termux)

å„ç§APPä¿å­˜çš„å›¾ç‰‡è§†é¢‘ï¼Œå»é‡åæ”¾åˆ°ç»Ÿä¸€æ–‡ä»¶å¤¹ã€‚

æ•°æ®èµ„æ–™æŒ‰ç…§å¯¹åº”çš„è·¯å¾„ä½¿ç”¨rcloneä¿å­˜åˆ°NASã€‚

ç›´æ¥è´´ä»£ç ï¼š

```python
import os
import shutil
import subprocess
import threading
import cv2
import hashlib
import numpy as np

PIC_SRCS = [
    "/sdcard/Pictures/Baimiao",
    "/sdcard/Pictures/QQ",
    "/sdcard/Pictures/Tieba Lite",
    "/sdcard/Pictures/Twitter",
    "/sdcard/Pictures/WeiXin",
    "/sdcard/Pictures/bili",
    "/sdcard/Pictures/ithome",
    "/sdcard/Pictures/æƒ³æ³•",
    "/sdcard/Pictures/çŸ¥ä¹",
    "/sdcard/tieba",
    "/sdcard/Tencent/QQ_Images",
    "/sdcard/pear/externaImga",
    "/sdcard/DCIM/tieba",
    "/sdcard/Movies/QQ",
]
PIC_DIST = "/sdcard/Pictures/æ‚å›¾æ±‡æ€»"
COPY_LIST = [
    ("/sdcard/termuxBackups", "nas:storage/Backups/termuxBackups"),
    ("/sdcard/DCIM/Camera", "nas:storage/Media/Pictures/æ‰‹æœºç›¸æœº"),
    ("/sdcard/Pictures/Pixiv", "nas:storage/Media/Pictures/Pixiv"),
    ("/sdcard/Pictures/pixez", "nas:storage/Media/Pictures/pixez"),
    ("/sdcard/DCIM/Screenshots", "nas:storage/Media/Pictures/æ‰‹æœºæˆªå›¾"),
    ("/sdcard/Pictures/æ‚å›¾æ±‡æ€»", "nas:storage/Media/Pictures/æ‚å›¾æ±‡æ€»"),
    ("/sdcard/MIUI/sound_recorder", "nas:storage/Backups/æ‰‹æœºå½•éŸ³"),
    ("/sdcard/ADM", "nas:storage/Backups/å­¦ä¹ èµ„æ–™/ADM"),
    ("/sdcard/Download/TwiTake", "nas:storage/Backups/å­¦ä¹ èµ„æ–™/TwiTake"),
    ("/sdcard/Download/xunleiTmp", "nas:storage/Backups/å­¦ä¹ èµ„æ–™/XunLei"),
    ("/sdcard/Download/QuarkDownloads/CloudDrive", "nas:storage/Backups/å­¦ä¹ èµ„æ–™/Quark"),
]

def getAllFiles(path):
    Filelist = []
    for home, dirs, files in os.walk(path):
        for filename in files:
            Filelist.append(os.path.join(home, filename))
    return Filelist

def calculateFileHASH(file_path):
    sha256_hash = hashlib.sha256()
    with open(file_path, "rb") as f:
        for byte_block in iter(lambda: f.read(4096), b""):
            sha256_hash.update(byte_block)
    return sha256_hash.hexdigest()


def calculateHash(image_path, hash_size=16):
    image = cv2.imread(image_path, cv2.IMREAD_GRAYSCALE)
    if image is None:
        return calculateFileHASH(image_path)
    resizedImage = cv2.resize(image, (hash_size, hash_size))
    avg = np.mean(resizedImage)
    ph = 0
    for row in resizedImage:
        for pixel in row:
            ph = (ph << 1) | (1 if pixel > avg else 0)
    return f"{ph:x}"


def run_command_with_timeout(command):
    process = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    def target():
        process.wait()
    thread = threading.Thread(target=target)
    thread.start()
    thread.join(timeout=3)  # è®¾ç½®è¶…æ—¶ä¸º3ç§’
    if thread.is_alive():
        process.kill()  # è¶…æ—¶åˆ™ç»ˆæ­¢è¿›ç¨‹
        thread.join()  # ç­‰å¾…çº¿ç¨‹ç»“æŸ
        return False
    else:
        return process.returncode == 0  # è¿”å›è¿›ç¨‹çš„è¿”å›ç æ˜¯å¦ä¸º0

if __name__ == "__main__":
    for src in PIC_SRCS:
        for file in getAllFiles(src):
            filename, ext = os.path.splitext(file)
            oldFilePath = file
            newFilePath = os.path.join(PIC_DIST, calculateHash(file) + ext.lower())
            if os.path.exists(newFilePath) and os.path.getsize(oldFilePath) >= os.path.getsize(newFilePath):
                os.remove(oldFilePath)
                print(f"åˆ é™¤:{oldFilePath}")
            else:
                shutil.move(src=oldFilePath, dst=newFilePath)
                print(f"ç§»åŠ¨:{oldFilePath}=>{newFilePath}")
    if not run_command_with_timeout(["rclone", "lsd", "nas:"]):
        print("NASç¦»çº¿")
        exit(1)
    for src, dst in COPY_LIST:
        print(f'\n$: rclone copy "{src}" "{dst}" -v --transfers=16')
        os.system(f'rclone copy "{src}" "{dst}" -v --transfers=16')
```

:::tip
æ²¡äº‹å¹²å¤šæˆªå±ï¼Œæ¡Œé¢ã€å¿«æ·æ ã€appåˆ—è¡¨ã€ä¸»é¢˜è®¾ç½®...

çœŸæ‰‹æœºä¸¢äº†ï¼Œè¿™äº›æ‰æ˜¯éš¾æçš„
:::

## NASå¤‡ä»½

NASä½œä¸ºä¸­è½¬ç«™ä¸æœ¬åœ°å¤‡ä»½ï¼Œæ‰‹æœºä¸è·¯ç”±å™¨å…ˆå¤‡ä»½åˆ°NASï¼Œç„¶åNASå†ä¸Šä¼ åˆ°äº‘ç«¯ã€‚

ä½¿ç”¨æ’ä»¶[appdata backup](https://forums.unraid.net/topic/137710-plugin-appdatabackup/)ï¼Œå¤‡ä»½appdataã€dockeré…ç½®æ–‡ä»¶ä¸é—ªå­˜ã€‚

æ¯å‘¨å¤‡ä»½å¹¶ä¸”åœ¨å¤‡ä»½å®Œæˆåï¼Œæ‰§è¡Œè„šæœ¬ä¸Šä¼ äº‘ç«¯ï¼ˆsyncæ¨¡å¼ï¼‰ã€‚

LXCå®¹å™¨æ‰‹åŠ¨å¤‡ä»½ã€‚

åª’ä½“æ•°æ®ç”¨è®¡åˆ’ä»»åŠ¡è„šæœ¬ä¸Šä¼ ã€‚

## ä¸€äº›Tip

* ä½¿ç”¨ \[ termux ğŸ”— termux\:Tasker ğŸ”— Macrodroid \] çš„æ—¶å€™ï¼Œåœ¨å›½äº§æ‰‹æœºä¸Šç»å¸¸ä¼šè¢«ç¦æ­¢è‡ªåŠ¨å¯åŠ¨å¯¼è‡´æ— æ³•æ‹‰èµ·ã€‚è§£å†³æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªè„šæœ¬å®šæ—¶é—´éš”è°ƒç”¨termuxã€‚

* rcloneä¸Šä¼ åˆ°äº‘ç«¯æ—¶ï¼Œçµæ´»è°ƒæ•´transfersï¼Œå‡å¼±ä¸Šä¼ å¼€å§‹å»¶è¿Ÿä¸”é¿å…åŒæ—¶ä¼ è¾“å¤šä¸ªå¤§æ–‡ä»¶ã€‚
